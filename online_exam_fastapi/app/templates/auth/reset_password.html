{% extends "base.html" %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
      <div class="card shadow-sm border-0">
        <div class="card-body p-4">
          <h1 class="h5 mb-3 text-center">Set a New Password</h1>

          {% if errors %}
          <div class="alert alert-danger" role="alert">
            <ul class="mb-0">
              {% for field, message in errors.items() %}
              <li>{{ message }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}

          <form method="post" novalidate id="resetPasswordForm">
            <div class="mb-3">
              <label for="password" class="form-label">New Password</label>
              <input
                type="password"
                class="form-control {% if errors.password %}is-invalid{% endif %}"
                id="password"
                name="password"
                autocomplete="new-password"
                required
              >
              <div class="invalid-feedback" id="passwordError"></div>
              
              <!-- Password Strength Indicator -->
              <div class="mt-2">
                <div class="progress" style="height: 5px;">
                  <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%;"></div>
                </div>
                <small class="text-muted" id="strengthText">Password strength: <span id="strengthLabel">-</span></small>
              </div>

              <!-- Password Requirements -->
              <div class="mt-2 small">
                <div id="req-length" class="text-muted">
                  <i class="bi bi-circle" id="icon-length"></i> At least 8 characters
                </div>
                <div id="req-uppercase" class="text-muted">
                  <i class="bi bi-circle" id="icon-uppercase"></i> At least 1 uppercase letter
                </div>
                <div id="req-lowercase" class="text-muted">
                  <i class="bi bi-circle" id="icon-lowercase"></i> At least 1 lowercase letter
                </div>
                <div id="req-digit" class="text-muted">
                  <i class="bi bi-circle" id="icon-digit"></i> At least 1 digit
                </div>
                <div id="req-special" class="text-muted">
                  <i class="bi bi-circle" id="icon-special"></i> At least 1 special character
                </div>
              </div>
            </div>

            <div class="mb-3">
              <label for="confirm_password" class="form-label">Confirm Password</label>
              <input
                type="password"
                class="form-control {% if errors.confirm_password %}is-invalid{% endif %}"
                id="confirm_password"
                name="confirm_password"
                autocomplete="new-password"
                required
              >
              <div class="invalid-feedback" id="confirmPasswordError"></div>
              <div class="valid-feedback" id="confirmPasswordSuccess" style="display: none;">
                Passwords match
              </div>
            </div>

            <div class="d-grid">
              <button type="submit" class="btn btn-primary" id="submitBtn">
                Update Password
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .bi-check-circle-fill {
    color: #28a745;
  }
  .bi-x-circle-fill {
    color: #dc3545;
  }
  .bi-circle {
    color: #6c757d;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm_password');
    const form = document.getElementById('resetPasswordForm');
    const submitBtn = document.getElementById('submitBtn');

    // Password validation rules
    const requirements = {
      length: { test: (p) => p.length >= 8, icon: 'icon-length', req: 'req-length' },
      uppercase: { test: (p) => /[A-Z]/.test(p), icon: 'icon-uppercase', req: 'req-uppercase' },
      lowercase: { test: (p) => /[a-z]/.test(p), icon: 'icon-lowercase', req: 'req-lowercase' },
      digit: { test: (p) => /[0-9]/.test(p), icon: 'icon-digit', req: 'req-digit' },
      special: { test: (p) => /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?/~`]/.test(p), icon: 'icon-special', req: 'req-special' }
    };

    function updateRequirementIcon(reqName, met) {
      const icon = document.getElementById(requirements[reqName].icon);
      const reqDiv = document.getElementById(requirements[reqName].req);
      if (met) {
        icon.className = 'bi bi-check-circle-fill';
        reqDiv.classList.remove('text-muted');
        reqDiv.classList.add('text-success');
      } else {
        icon.className = 'bi bi-circle';
        reqDiv.classList.remove('text-success');
        reqDiv.classList.add('text-muted');
      }
    }

    function calculatePasswordStrength(password) {
      let strength = 0;
      let score = 0;

      // Check each requirement
      Object.keys(requirements).forEach(req => {
        if (requirements[req].test(password)) {
          score++;
        }
      });

      // Length bonus
      if (password.length >= 12) score += 0.5;
      if (password.length >= 16) score += 0.5;

      // Calculate strength percentage
      strength = Math.min((score / 5.5) * 100, 100);

      return {
        percentage: strength,
        score: score,
        label: strength < 20 ? 'Very Weak' :
               strength < 40 ? 'Weak' :
               strength < 60 ? 'Fair' :
               strength < 80 ? 'Good' :
               'Strong'
      };
    }

    function updatePasswordStrength(password) {
      const strength = calculatePasswordStrength(password);
      const strengthBar = document.getElementById('strengthBar');
      const strengthLabel = document.getElementById('strengthLabel');

      strengthBar.style.width = strength.percentage + '%';
      strengthLabel.textContent = strength.label;

      // Update color based on strength
      if (strength.percentage < 40) {
        strengthBar.className = 'progress-bar bg-danger';
      } else if (strength.percentage < 60) {
        strengthBar.className = 'progress-bar bg-warning';
      } else if (strength.percentage < 80) {
        strengthBar.className = 'progress-bar bg-info';
      } else {
        strengthBar.className = 'progress-bar bg-success';
      }

      // Update requirement icons
      Object.keys(requirements).forEach(req => {
        updateRequirementIcon(req, requirements[req].test(password));
      });
    }

    function validatePassword() {
      const password = passwordInput.value;
      const errors = [];

      if (!password) {
        passwordInput.classList.add('is-invalid');
        document.getElementById('passwordError').textContent = 'Password is required.';
        return false;
      }

      if (password.length < 8) {
        errors.push('Password must be at least 8 characters long.');
      }
      if (!/[A-Z]/.test(password)) {
        errors.push('Password must contain at least one uppercase letter.');
      }
      if (!/[a-z]/.test(password)) {
        errors.push('Password must contain at least one lowercase letter.');
      }
      if (!/[0-9]/.test(password)) {
        errors.push('Password must contain at least one number.');
      }
      if (!/[!@#$%^&*()_+\-=\[\]{}|;:,.<>?/~`]/.test(password)) {
        errors.push('Password must contain at least one special character.');
      }

      if (errors.length > 0) {
        passwordInput.classList.add('is-invalid');
        passwordInput.classList.remove('is-valid');
        document.getElementById('passwordError').textContent = errors[0];
        return false;
      } else {
        passwordInput.classList.remove('is-invalid');
        passwordInput.classList.add('is-valid');
        document.getElementById('passwordError').textContent = '';
        return true;
      }
    }

    function validateConfirmPassword() {
      const password = passwordInput.value;
      const confirmPassword = confirmPasswordInput.value;

      if (!confirmPassword) {
        confirmPasswordInput.classList.add('is-invalid');
        confirmPasswordInput.classList.remove('is-valid');
        document.getElementById('confirmPasswordError').textContent = 'Please confirm your password.';
        document.getElementById('confirmPasswordSuccess').style.display = 'none';
        return false;
      }

      if (password !== confirmPassword) {
        confirmPasswordInput.classList.add('is-invalid');
        confirmPasswordInput.classList.remove('is-valid');
        document.getElementById('confirmPasswordError').textContent = 'Passwords do not match.';
        document.getElementById('confirmPasswordSuccess').style.display = 'none';
        return false;
      } else {
        confirmPasswordInput.classList.remove('is-invalid');
        confirmPasswordInput.classList.add('is-valid');
        document.getElementById('confirmPasswordError').textContent = '';
        document.getElementById('confirmPasswordSuccess').style.display = 'block';
        return true;
      }
    }

    // Live validation on input
    passwordInput.addEventListener('input', function() {
      updatePasswordStrength(this.value);
      validatePassword();
      if (confirmPasswordInput.value) {
        validateConfirmPassword();
      }
    });

    confirmPasswordInput.addEventListener('input', function() {
      validateConfirmPassword();
    });

    // Form submission validation
    form.addEventListener('submit', function(e) {
      const isPasswordValid = validatePassword();
      const isConfirmValid = validateConfirmPassword();

      if (!isPasswordValid || !isConfirmValid) {
        e.preventDefault();
        e.stopPropagation();
      }
    });
  });
</script>
{% endblock %}


