{% extends "base.html" %}
{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      {% if is_graded %}
        <h2 class="h4 mb-0">Review Graded Attempt #{{ attempt.id }} — {{ exam.title }}</h2>
      {% else %}
        <h2 class="h4 mb-0">Grade Attempt #{{ attempt.id }} — {{ exam.title }}</h2>
      {% endif %}
      <small class="text-muted">Student: {{ student.name if student else ('ID ' ~ attempt.student_id) }} &nbsp; Status: {{ attempt.status }}
        {% if is_graded %}
          &nbsp; <span class="badge bg-success">Status: Graded (Read-only)</span>
        {% endif %}
      </small>
    </div>
    {% if attempt and attempt.started_at and attempt.status != 'submitted' %}
      <div>
        <strong>Time left:</strong> <span id="grade-countdown">--:--</span>
      </div>
    {% endif %}
  </div>

  <!-- Final Score Summary (Always Visible) -->
  <div class="card mb-4 border-success" {% if is_graded %}style="background-color:#f0fff4;"{% endif %}>
    <div class="card-body text-center">
      <h4>Final Total Score</h4>
      <h1 class="display-4 text-success">{{ total_current }} / {{ total_possible }}</h1>
      {% if is_graded %}
        <small class="text-muted">Graded on {{ attempt.submitted_at.strftime('%Y-%m-%d %H:%M:%S') if attempt.submitted_at else 'N/A' }}</small>
      {% endif %}
    </div>
  </div>

  <form method="post" {% if is_graded %}style="pointer-events: none; opacity: 0.6;"{% endif %}>
    {% for q in questions %}
      {% set current_marks = (answers_map.get(q.id).marks_awarded if answers_map.get(q.id) and answers_map.get(q.id).marks_awarded is not none else 0) %}
      <div class="card mb-3">
        <div class="card-body">
          <div class="d-flex justify-content-between">
            <div>
              <label class="form-label"><strong>Q{{ loop.index }}:</strong> {{ q.question_text }}</label>
              <p class="small text-muted">Answer: {{ answers_map.get(q.id).answer_text if answers_map.get(q.id) }}</p>
              {% if is_graded and answers_map.get(q.id) and answers_map.get(q.id).grader_feedback %}
                <div class="mt-2 p-2 bg-light rounded">
                  <small class="text-muted"><strong>Feedback:</strong></small>
                  <p class="mb-0">{{ answers_map.get(q.id).grader_feedback }}</p>
                </div>
              {% endif %}
            </div>
            <div style="min-width:180px; text-align:right;">
              <div class="mb-2 small text-muted">Max: {{ q.max_marks or 0 }}</div>
              <input type="number" min="0" max="{{ q.max_marks or 0 }}" name="score_{{ q.id }}" class="form-control" value="{{ current_marks }}" {% if is_graded %}readonly disabled{% endif %} />
            </div>
          </div>
        </div>
      </div>
    {% endfor %}

    {% if not is_graded %}
      <div class="d-flex justify-content-end mb-4">
        <button type="submit" class="btn btn-lg btn-primary">Save Scores</button>
      </div>
    {% endif %}
  </form>

  {% if attempt and attempt.started_at and attempt.status != 'submitted' %}
  <script>
    (function(){
      // Show countdown if attempt still in progress
      const startedAt = new Date("{{ attempt.started_at.isoformat() }}");
      const durationMinutes = {{ exam.duration_minutes or 0 }};
      const endTime = new Date(startedAt.getTime() + durationMinutes*60000);
      const el = document.getElementById('grade-countdown');
      if(!el) return;
      function update(){
        const now = new Date();
        let diff = Math.max(0, Math.floor((endTime - now)/1000));
        const mins = Math.floor(diff/60).toString().padStart(2,'0');
        const secs = (diff%60).toString().padStart(2,'0');
        el.textContent = mins + ':' + secs;
        if(diff<=0){ clearInterval(t); el.textContent = '00:00'; }
      }
      update();
      const t = setInterval(update,1000);
    })();
  </script>
  {% endif %}
</div>
{% endblock %}