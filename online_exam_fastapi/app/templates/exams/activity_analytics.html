{% extends "base.html" %}
{% block title %}Activity Analytics - {{ exam.title }}{% endblock %}
{% block content %}
<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>Activity Analytics: {{ exam.title }}</h2>
      <p class="text-muted">{{ exam.subject }}</p>
    </div>
    <div>
      <a href="/exams/{{ exam.id }}/activity-logs" class="btn btn-primary">View Activity Logs</a>
      <a href="/exams/{{ exam.id }}" class="btn btn-secondary">Back to Exam</a>
    </div>
  </div>

  <!-- Overall Statistics -->
  <div class="row mb-4 g-3">
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Total Students</h5>
          <h3 class="text-primary mb-0">{{ overall_stats.total_students_with_activities }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card border-danger h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title text-danger">Flagged Students</h5>
          <h3 class="text-danger mb-0">{{ overall_stats.flagged_students_count }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Total Activities</h5>
          <h3 class="text-info mb-0">{{ overall_stats.total_activities }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">Average Score</h5>
          <h3 class="text-warning mb-0">{{ "%.1f"|format(overall_stats.average_score) }}</h3>
          <small class="text-muted mt-auto">Flag threshold: {{ flag_threshold }}</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Flagged Students Alert -->
  {% if flagged_students %}
  <div class="alert alert-danger mb-4">
    <h5><i class="bi bi-exclamation-triangle"></i> {{ flagged_students|length }} Student(s) Flagged for Review</h5>
    <p class="mb-0">The following students have activity scores ≥ {{ flag_threshold }} and require attention:</p>
    <ul class="mb-0 mt-2">
      {% for student in flagged_students %}
      <li><strong>{{ student.student.name if student.student else "Unknown" }}</strong> - Score: {{ student.score }} ({{ student.total_activities }} activities)</li>
      {% endfor %}
    </ul>
  </div>
  {% else %}
  <div class="alert alert-success mb-4">
    <h5><i class="bi bi-check-circle"></i> No Students Flagged</h5>
    <p class="mb-0">All students have activity scores below the threshold of {{ flag_threshold }}.</p>
  </div>
  {% endif %}

  <!-- Charts Section -->
  {% if analytics %}
  <div class="row mb-4 g-4">
    <!-- Activity Scores Bar Chart -->
    <div class="col-lg-8">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Activity Scores by Student</h5>
        </div>
        <div class="card-body">
          <canvas id="scoreChart" style="max-height: 400px;"></canvas>
        </div>
      </div>
    </div>

    <!-- Severity Breakdown Pie Chart -->
    <div class="col-lg-4">
      <div class="card border-0 shadow-sm h-100">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0"><i class="bi bi-pie-chart me-2"></i>Severity Breakdown</h5>
        </div>
        <div class="card-body">
          <canvas id="severityChart" style="max-height: 300px;"></canvas>
        </div>
      </div>
    </div>

    <!-- Activity Types Breakdown -->
    <div class="col-lg-12">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom">
          <h5 class="mb-0"><i class="bi bi-graph-up me-2"></i>Activity Types Distribution</h5>
        </div>
        <div class="card-body">
          <canvas id="activityTypesChart" style="max-height: 350px;"></canvas>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Student Analytics Table -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0">Student Activity Analytics</h5>
      <small class="text-muted">Scoring: Low=1, Medium=3, High=10 | Flagged if Score ≥ {{ flag_threshold }}</small>
    </div>
    <div class="card-body">
      {% if analytics %}
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead>
            <tr>
              <th>Student</th>
              <th>Activity Score</th>
              <th>Total Activities</th>
              <th>Severity Breakdown</th>
              <th>Activity Types</th>
              <th>Last Activity</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody>
            {% for item in analytics %}
            <tr class="{% if item.flagged %}table-danger{% endif %}">
              <td>
                <strong>
                  {% if item.student %}
                    {{ item.student.name }}
                    <br><small class="text-muted">{{ item.student.matric_no }}</small>
                  {% else %}
                    Student ID: {{ item.student_id if item.student_id else 'Unknown' }}
                  {% endif %}
                </strong>
              </td>
              <td>
                <span class="badge {% if item.score >= flag_threshold %}bg-danger{% elif item.score >= flag_threshold * 0.7 %}bg-warning{% else %}bg-info{% endif %} fs-6">
                  {{ item.score }}
                </span>
              </td>
              <td>{{ item.total_activities }}</td>
              <td>
                <small>
                  <span class="badge bg-danger">{{ item.by_severity.high }}H</span>
                  <span class="badge bg-warning">{{ item.by_severity.medium }}M</span>
                  <span class="badge bg-info">{{ item.by_severity.low }}L</span>
                </small>
              </td>
              <td>
                <small>
                  {% for act_type, count in item.by_type.items() %}
                    <code>{{ act_type.replace('_', ' ') }}</code>: {{ count }}{% if not loop.last %}<br>{% endif %}
                  {% endfor %}
                </small>
              </td>
              <td>
                <small>{{ item.last_activity.strftime('%Y-%m-%d %H:%M:%S') }}</small>
              </td>
              <td>
                {% if item.flagged %}
                  <span class="badge bg-danger">FLAGGED</span>
                {% else %}
                  <span class="badge bg-success">OK</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-info">No activity data available for this exam.</div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Chart Initialization Script -->
{% if analytics and analytics_json %}
<script>
  // Wait for everything to be ready
  window.addEventListener('load', function() {
    // Double check Chart.js is available
    if (typeof Chart === 'undefined') {
      console.error('Chart.js library failed to load');
      document.getElementById('scoreChart')?.parentElement?.insertAdjacentHTML('beforeend', '<div class="alert alert-danger">Failed to load chart library. Please refresh the page.</div>');
      return;
    }

    // Prepare data for charts
    const analyticsData = {{ analytics_json|tojson }};
    const flagThreshold = {{ flag_threshold }};

    console.log('Initializing charts with data:', analyticsData);

    // Validate data
    if (!analyticsData || analyticsData.length === 0) {
      console.warn('No analytics data available for charts');
      return;
    }

    // 1. Activity Scores Bar Chart
    const scoreCanvas = document.getElementById('scoreChart');
    if (!scoreCanvas) {
      console.error('scoreChart canvas not found!');
      return;
    }
    const scoreCtx = scoreCanvas.getContext('2d');
  const studentNames = analyticsData.map(a => a.student ? (a.student.name + (a.student.matric_no ? ' (' + a.student.matric_no + ')' : '')) : 'Student ' + a.student_id);
  const scores = analyticsData.map(a => a.score);
  const flaggedIndices = analyticsData.map((a, i) => a.flagged ? i : null).filter(i => i !== null);
  
  new Chart(scoreCtx, {
    type: 'bar',
    data: {
      labels: studentNames,
      datasets: [{
        label: 'Activity Score',
        data: scores,
        backgroundColor: scores.map((score, i) => 
          score >= flagThreshold ? 'rgba(220, 53, 69, 0.7)' : 
          score >= flagThreshold * 0.7 ? 'rgba(255, 193, 7, 0.7)' : 
          'rgba(13, 110, 253, 0.7)'
        ),
        borderColor: scores.map((score, i) => 
          score >= flagThreshold ? 'rgba(220, 53, 69, 1)' : 
          score >= flagThreshold * 0.7 ? 'rgba(255, 193, 7, 1)' : 
          'rgba(13, 110, 253, 1)'
        ),
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const index = context.dataIndex;
              const student = analyticsData[index];
              return [
                'Score: ' + context.parsed.y,
                'Activities: ' + student.total_activities,
                student.flagged ? 'Status: FLAGGED' : 'Status: OK'
              ];
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Activity Score'
          },
          grid: {
            color: function(context) {
              if (context.tick.value === flagThreshold) {
                return 'rgba(220, 53, 69, 0.5)';
              }
              return 'rgba(0, 0, 0, 0.1)';
            }
          },
          ticks: {
            callback: function(value) {
              if (value === flagThreshold) {
                return value + ' (Flag Threshold)';
              }
              return value;
            }
          }
        },
        x: {
          title: {
            display: true,
            text: 'Students'
          },
          ticks: {
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });

    // 2. Severity Breakdown Pie Chart
    const severityCanvas = document.getElementById('severityChart');
    if (!severityCanvas) {
      console.error('severityChart canvas not found!');
      return;
    }
    const severityCtx = severityCanvas.getContext('2d');
  const totalHigh = analyticsData.reduce((sum, a) => sum + (a.by_severity.high || 0), 0);
  const totalMedium = analyticsData.reduce((sum, a) => sum + (a.by_severity.medium || 0), 0);
  const totalLow = analyticsData.reduce((sum, a) => sum + (a.by_severity.low || 0), 0);

  new Chart(severityCtx, {
    type: 'doughnut',
    data: {
      labels: ['High Severity', 'Medium Severity', 'Low Severity'],
      datasets: [{
        data: [totalHigh, totalMedium, totalLow],
        backgroundColor: [
          'rgba(220, 53, 69, 0.8)',
          'rgba(255, 193, 7, 0.8)',
          'rgba(13, 110, 253, 0.8)'
        ],
        borderColor: [
          'rgba(220, 53, 69, 1)',
          'rgba(255, 193, 7, 1)',
          'rgba(13, 110, 253, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              const label = context.label || '';
              const value = context.parsed || 0;
              const total = totalHigh + totalMedium + totalLow;
              const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return label + ': ' + value + ' (' + percentage + '%)';
            }
          }
        }
      }
    }
  });

    // 3. Activity Types Distribution Chart
    const activityTypesCanvas = document.getElementById('activityTypesChart');
    if (!activityTypesCanvas) {
      console.error('activityTypesChart canvas not found!');
      return;
    }
    const activityTypesCtx = activityTypesCanvas.getContext('2d');
  const activityTypesMap = {};
  analyticsData.forEach(student => {
    Object.keys(student.by_type || {}).forEach(type => {
      if (!activityTypesMap[type]) {
        activityTypesMap[type] = 0;
      }
      activityTypesMap[type] += student.by_type[type];
    });
  });

  const activityTypes = Object.keys(activityTypesMap).sort();
  const activityCounts = activityTypes.map(type => activityTypesMap[type]);
  const activityLabels = activityTypes.map(type => type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));

  new Chart(activityTypesCtx, {
    type: 'bar',
    data: {
      labels: activityLabels,
      datasets: [{
        label: 'Number of Activities',
        data: activityCounts,
        backgroundColor: 'rgba(13, 110, 253, 0.7)',
        borderColor: 'rgba(13, 110, 253, 1)',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      indexAxis: 'y',
      plugins: {
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return 'Count: ' + context.parsed.x;
            }
          }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Number of Activities'
          },
          ticks: {
            stepSize: 1
          }
        },
        y: {
          title: {
            display: true,
            text: 'Activity Types'
          }
        }
      }
    }
  });

  }); // End window load event
</script>
{% endif %}
{% endblock %}

