{% extends 'base.html' %}
{% block title %}Join Exam{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2>Exam: {{ exam.title }}</h2>
  <form id="mcqForm">
    <input type="hidden" name="student_id" value="{{ student.id }}">
    <input type="hidden" name="exam_id" value="{{ exam.id }}">
    <div id="timer" class="alert alert-info">Time left: <span id="timeLeft"></span></div>
    <div class="alert alert-warning" role="alert">
      <strong>Exam Security:</strong> Anti-cheating measures are active. Right-click, copy/paste, and developer tools are disabled.
    </div>
    
    <!-- MCQ Questions Section -->
    {% if mcq_questions %}
    <h3 class="mt-4 mb-3">Multiple Choice Questions</h3>
    {% for q in mcq_questions %}
      <div class="card mb-3">
        <div class="card-header">
          Q{{ loop.index }}. {{ q.question_text }}
        </div>
        <div class="card-body">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q{{ q.id }}" value="A" id="q{{ q.id }}A" {% if answer_map[q.id]=='A' %}checked{% endif %}>
            <label class="form-check-label" for="q{{ q.id }}A">A. {{ q.option_a }}</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q{{ q.id }}" value="B" id="q{{ q.id }}B" {% if answer_map[q.id]=='B' %}checked{% endif %}>
            <label class="form-check-label" for="q{{ q.id }}B">B. {{ q.option_b }}</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q{{ q.id }}" value="C" id="q{{ q.id }}C" {% if answer_map[q.id]=='C' %}checked{% endif %}>
            <label class="form-check-label" for="q{{ q.id }}C">C. {{ q.option_c }}</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q{{ q.id }}" value="D" id="q{{ q.id }}D" {% if answer_map[q.id]=='D' %}checked{% endif %}>
            <label class="form-check-label" for="q{{ q.id }}D">D. {{ q.option_d }}</label>
          </div>
        </div>
      </div>
    {% endfor %}
    {% endif %}
    
    <!-- Essay Questions Section -->
    {% if essay_questions %}
    <h3 class="mt-4 mb-3">Essay Questions</h3>
    <div class="alert alert-info">
      <strong>Note:</strong> Essay answers will be reviewed and graded manually by your instructor.
    </div>
    {% for q in essay_questions %}
      <div class="card mb-3">
        <div class="card-header">
          Q{{ mcq_questions|length + loop.index }}. {{ q.question_text }}
        </div>
        <div class="card-body">
          <textarea class="form-control" name="essay_{{ q.id }}" rows="6" placeholder="Enter your answer here..."></textarea>
          <small class="form-text text-muted mt-2">Max marks: {{ q.max_marks }}</small>
        </div>
      </div>
    {% endfor %}
    {% endif %}
    
    <button type="button" class="btn btn-primary" onclick="submitExam()">Submit Exam</button>
  </form>
</div>
<script id="mcq-data" type="application/json">
  {
    "student_id": {{ student.id|tojson }},
    "exam_id": {{ exam.id|tojson }},
    "duration": {{ exam.duration_minutes|tojson }},
    "exam_end_time": {{ exam_end_time|tojson }},
    "question_ids": [{% for q in mcq_questions %}{{ q.id }}{% if not loop.last %}, {% endif %}{% endfor %}],
    "has_only_mcq": {{ has_only_mcq|tojson }}
  }
</script>
<!-- Exam Context for Anti-Cheating Logging -->
<script id="exam-context-data" type="application/json">
  {
    "exam_id": {{ exam.id|tojson }},
    "student_id": {{ student.id|tojson }},
    "attempt_id": null,
    "log_endpoint": "/exams/{{ exam.id }}/log-activity"
  }
</script>
<!-- Anti-Cheating Measures -->
<script src="/static/myschool/assets/js/anti-cheating.js"></script>
<script>
// Timer and auto-save logic
const mcqData = JSON.parse(document.getElementById('mcq-data').textContent);
let timeLeft = 0;
const timeLeftEl = document.getElementById('timeLeft');

// Calculate time left based on exam end time
function calculateTimeLeft() {
  if (mcqData.exam_end_time) {
    const endTime = new Date(mcqData.exam_end_time);
    const now = new Date();
    timeLeft = Math.max(0, Math.floor((endTime - now) / 1000));
  }
}

calculateTimeLeft();

function updateTimer() {
  if (timeLeft > 0) {
    timeLeft--;
    let min = Math.floor(timeLeft / 60);
    let sec = timeLeft % 60;
    timeLeftEl.textContent = `${min}:${sec.toString().padStart(2, '0')}`;
  } else {
    submitExam(true);
  }
}
setInterval(updateTimer, 1000);

// Auto-save every 60 seconds
function autoSave() {
  const form = document.getElementById('mcqForm');
  const data = new FormData(form);
  let answers = {};
  let essay_answers = {};
  
  mcqData.question_ids.forEach(function(qid) {
    answers[qid] = data.get('q' + qid);
  });
  
  // Collect essay answers if they exist
  const essayInputs = form.querySelectorAll('textarea[name^="essay_"]');
  essayInputs.forEach(function(input) {
    const qid = input.name.replace('essay_', '');
    essay_answers[qid] = input.value;
  });
  
  fetch(`/exams/${mcqData.exam_id}/autosave`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ student_id: mcqData.student_id, answers, essay_answers })
  }).catch(err => {
    console.error('Auto-save failed:', err);
  });
}

// Auto-save every 10 seconds
setInterval(autoSave, 10000);

function submitExam(auto=false) {
  const form = document.getElementById('mcqForm');
  const data = new FormData(form);
  let answers = {};
  let essay_answers = {};
  
  mcqData.question_ids.forEach(function(qid) {
    answers[qid] = data.get('q' + qid);
  });
  
  // Collect essay answers if they exist
  const essayInputs = form.querySelectorAll('textarea[name^="essay_"]');
  essayInputs.forEach(function(input) {
    const qid = input.name.replace('essay_', '');
    essay_answers[qid] = input.value;
  });
  
  // Save answers first via autosave
  fetch(`/exams/${mcqData.exam_id}/autosave`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ student_id: mcqData.student_id, answers, essay_answers })
  }).then(r => {
    // If there are MCQ questions, submit them for grading
    if (mcqData.question_ids.length > 0) {
      return fetch(`/exams/${mcqData.exam_id}/submit`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ student_id: mcqData.student_id, answers })
      });
    }
    return r;
  }).then(r => {
    // If there are essay answers, mark the attempt as final/submitted
    if (Object.keys(essay_answers).length > 0) {
      return fetch(`/exams/${mcqData.exam_id}/submit-essay`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ student_id: mcqData.student_id })
      });
    }
    return r;
  }).then(r => {
    // Show success message and redirect to finished page
    alert('Exam submitted successfully! Your answers have been saved.');
    window.location.href = `/exams/exam_finished`;
  }).catch(err => {
    console.error('Submit failed:', err);
    alert('Error submitting exam. Please try again.');
  });
}
</script>
{% endblock %}
