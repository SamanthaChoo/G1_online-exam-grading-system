{% extends 'base.html' %}
{% block title %}Join Exam{% endblock %}
{% block content %}
<div class="container mt-4">
  <h2>Exam: {{ exam.title }}</h2>
  <form id="mcqForm">
    <input type="hidden" name="student_id" value="{{ student.id }}">
    <input type="hidden" name="exam_id" value="{{ exam.id }}">
    <div id="timer" class="alert alert-info">Time left: <span id="timeLeft"></span></div>
    <div class="alert alert-warning" role="alert">
      <strong>Exam Security:</strong> Anti-cheating measures are active. Right-click, copy/paste, and developer tools are disabled.
    </div>
    {% for q in questions %}
      <div class="card mb-3">
        <div class="card-header">
          Q{{ loop.index }}. {{ q.question_text }}
        </div>
        <div class="card-body">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q{{ q.id }}" value="A" id="q{{ q.id }}A" {% if answer_map[q.id]=='A' %}checked{% endif %}>
            <label class="form-check-label" for="q{{ q.id }}A">A. {{ q.option_a }}</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q{{ q.id }}" value="B" id="q{{ q.id }}B" {% if answer_map[q.id]=='B' %}checked{% endif %}>
            <label class="form-check-label" for="q{{ q.id }}B">B. {{ q.option_b }}</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q{{ q.id }}" value="C" id="q{{ q.id }}C" {% if answer_map[q.id]=='C' %}checked{% endif %}>
            <label class="form-check-label" for="q{{ q.id }}C">C. {{ q.option_c }}</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="q{{ q.id }}" value="D" id="q{{ q.id }}D" {% if answer_map[q.id]=='D' %}checked{% endif %}>
            <label class="form-check-label" for="q{{ q.id }}D">D. {{ q.option_d }}</label>
          </div>
        </div>
      </div>
    {% endfor %}
    <button type="button" class="btn btn-primary" onclick="submitExam()">Submit Exam</button>
  </form>
</div>
<script id="mcq-data" type="application/json">
  {
    "student_id": {{ student.id|tojson }},
    "exam_id": {{ exam.id|tojson }},
    "duration": {{ exam.duration_minutes|tojson }},
    "question_ids": [{% for q in questions %}{{ q.id }}{% if not loop.last %}, {% endif %}{% endfor %}]
  }
</script>
<!-- Exam Context for Anti-Cheating Logging -->
<script id="exam-context-data" type="application/json">
  {
    "exam_id": {{ exam.id|tojson }},
    "student_id": {{ student.id|tojson }},
    "attempt_id": null,
    "log_endpoint": "/exams/{{ exam.id }}/log-activity"
  }
</script>
<!-- Anti-Cheating Measures -->
<script src="/static/myschool/assets/js/anti-cheating.js"></script>
<script>
// Timer and auto-save logic
const mcqData = JSON.parse(document.getElementById('mcq-data').textContent);
let duration = mcqData.duration * 60; // seconds
let timeLeft = duration;
const timeLeftEl = document.getElementById('timeLeft');
function updateTimer() {
  if (timeLeft > 0) {
    timeLeft--;
    let min = Math.floor(timeLeft / 60);
    let sec = timeLeft % 60;
    timeLeftEl.textContent = `${min}:${sec.toString().padStart(2, '0')}`;
    if (timeLeft % 60 === 0) autoSave();
  } else {
    submitExam(true);
  }
}
setInterval(updateTimer, 1000);

function autoSave() {
  const form = document.getElementById('mcqForm');
  const data = new FormData(form);
  let answers = {};
  mcqData.question_ids.forEach(function(qid) {
    answers[qid] = data.get('q' + qid);
  });
  fetch(`/exams/${mcqData.exam_id}/autosave`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ student_id: mcqData.student_id, answers })
  });
}

function submitExam(auto=false) {
  const form = document.getElementById('mcqForm');
  const data = new FormData(form);
  let answers = {};
  mcqData.question_ids.forEach(function(qid) {
    answers[qid] = data.get('q' + qid);
  });
  fetch(`/exams/${mcqData.exam_id}/submit`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ student_id: mcqData.student_id, answers })
  }).then(r => r.json()).then(res => {
    window.location.href = '/exams/exam_finished';
  });
}
</script>
{% endblock %}
