{% extends 'base.html' %}

{% block title %}Filter Results by Course{% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <div class="row">
    <div class="col-12">
      <h2 class="mb-4">View Results</h2>
      
      <!-- Course Selection Card -->
      <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Select a Course</h5>
        </div>
        <div class="card-body">
          <form method="get" class="row g-3 align-items-end" id="courseForm">
            <div class="col-md-6">
              <label for="courseSelect" class="form-label">Course</label>
              <select 
                id="courseSelect" 
                name="course_id" 
                class="form-select"
                onchange="handleCourseChange()"
              >
                <option value="">-- Select a Course --</option>
                {% for course in courses %}
                  <option value="{{ course.id }}" {% if selected_course and selected_course.id == course.id %}selected{% endif %}>
                    {{ course.code }} - {{ course.name }}
                  </option>
                {% endfor %}
              </select>
              {% if not courses %}
                <small class="text-muted">No courses assigned to you.</small>
              {% endif %}
            </div>
          </form>
        </div>

        <script>
          function handleCourseChange() {
            const form = document.getElementById('courseForm');
            const courseSelect = document.getElementById('courseSelect');
            
            if (courseSelect.value === '') {
              // Clear the query parameter
              window.location.href = '/lecturer/results';
            } else {
              // Submit the form with the selected course_id
              form.submit();
            }
          }
        </script>
      </div>

      <!-- Results Section -->
      {% if selected_course %}
        {% if grouped_results %}
          <!-- Results Found -->
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i>
            Showing results for <strong>{{ selected_course.code }} - {{ selected_course.name }}</strong>
          </div>

          <!-- Results by Exam -->
          {% for exam_group in grouped_results %}
          <div class="card mb-4 border-left border-primary">
            <div class="card-header bg-light">
              <h5 class="mb-0">
                <i class="bi bi-file-text"></i>
                {{ exam_group.exam.title }}
                <small class="text-muted">({{ exam_group.exam.subject }})</small>
              </h5>
            </div>
            <div class="card-body">
              <!-- Exam Metadata -->
              <div class="row mb-3 pb-3 border-bottom">
                <div class="col-md-3">
                  <small class="text-muted">Duration:</small><br>
                  <span>{{ exam_group.exam.duration_minutes }} minutes</span>
                </div>
                <div class="col-md-3">
                  <small class="text-muted">Status:</small><br>
                  {% if exam_group.exam.status == 'scheduled' %}
                    <span class="badge bg-secondary">Scheduled</span>
                  {% elif exam_group.exam.status == 'completed' %}
                    <span class="badge bg-success">Completed</span>
                  {% else %}
                    <span class="badge bg-light text-dark">{{ exam_group.exam.status }}</span>
                  {% endif %}
                </div>
                <div class="col-md-3">
                  <small class="text-muted">Total Submissions:</small><br>
                  <span class="badge bg-info">{{ exam_group.students|length }}</span>
                </div>
              </div>

              <!-- Student Results Table -->
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead class="table-light">
                    <tr>
                      <th>Student Name</th>
                      <th>Matric No.</th>
                      <th>Submission Status</th>
                      <th>MCQ Score</th>
                      <th>Essay Score</th>
                      <th>Total Score</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for result in exam_group.students %}
                    <tr>
                      <!-- Student Info -->
                      <td>
                        <strong>{{ result.student.name }}</strong>
                      </td>
                      <td>
                        <small class="text-muted">{{ result.student.matric_no }}</small>
                      </td>
                      
                      <!-- Submission Status -->
                      <td>
                        {% if result.attempt.submitted_at %}
                          <span class="badge bg-success">Submitted</span>
                        {% elif result.attempt.status == 'timed_out' %}
                          <span class="badge bg-warning">Timed Out</span>
                        {% else %}
                          <span class="badge bg-secondary">{{ result.attempt.status }}</span>
                        {% endif %}
                      </td>
                      
                      <!-- MCQ Score -->
                      <td>
                        {% if result.mcq_result %}
                          <strong>{{ result.mcq_result.score }}/{{ result.mcq_result.total_questions }}</strong>
                          <small class="text-muted d-block">
                            ({{ ((result.mcq_result.score / result.mcq_result.total_questions * 100)|round(1)) }}%)
                          </small>
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      
                      <!-- Essay Score -->
                      <td>
                        {% if result.essay_total is not none %}
                          <strong>{{ result.essay_total }}</strong>
                          <small class="text-muted d-block">pts</small>
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                      
                      <!-- Total Score (MCQ + Essay) -->
                      <td>
                        {% set mcq_score = result.mcq_result.score if result.mcq_result else 0 %}
                        {% set essay_score = result.essay_total if result.essay_total is not none else 0 %}
                        {% if result.mcq_result or result.essay_total is not none %}
                          <strong class="text-primary">{{ mcq_score + essay_score }}</strong>
                        {% else %}
                          <span class="text-muted">-</span>
                        {% endif %}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>

              <!-- Essay Details Accordion (if there are essay answers) -->
              {% for result in exam_group.students %}
                {% if result.essay_answers %}
                <div class="accordion mt-3" id="essayAccordion{{ result.student.id }}">
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button 
                        class="accordion-button collapsed" 
                        type="button" 
                        data-bs-toggle="collapse" 
                        data-bs-target="#essayContent{{ result.student.id }}"
                      >
                        <i class="bi bi-arrow-down-circle"></i>
                        {{ result.student.name }} - Essay Answers
                      </button>
                    </h2>
                    <div 
                      id="essayContent{{ result.student.id }}" 
                      class="accordion-collapse collapse" 
                      data-bs-parent="#essayAccordion{{ result.student.id }}"
                    >
                      <div class="accordion-body">
                        {% for answer in result.essay_answers %}
                        <div class="mb-4 p-3 bg-light rounded">
                          <h6 class="mb-2">Question {{ loop.index }}</h6>
                          <p class="text-muted small">{{ answer.question_id }}</p>
                          
                          {% if answer.answer_text %}
                          <div class="mb-2">
                            <strong>Answer:</strong>
                            <p class="border-start ps-3 mt-2">{{ answer.answer_text }}</p>
                          </div>
                          {% endif %}
                          
                          {% if answer.marks_awarded is not none %}
                          <div class="row">
                            <div class="col-md-6">
                              <small><strong>Marks Awarded:</strong></small>
                              <p>{{ answer.marks_awarded }}</p>
                            </div>
                            <div class="col-md-6">
                              {% if answer.grader_feedback %}
                              <small><strong>Feedback:</strong></small>
                              <p class="text-muted">{{ answer.grader_feedback }}</p>
                              {% endif %}
                            </div>
                          </div>
                          {% else %}
                          <span class="badge bg-warning">Not Graded</span>
                          {% endif %}
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
          {% endfor %}

        {% else %}
          <!-- No Results Message -->
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle"></i>
            <strong>No results available</strong> for {{ selected_course.code }} - {{ selected_course.name }}.
            <br>
            <small>This course may not have any exams yet, or exams may not have any student submissions.</small>
          </div>
        {% endif %}

      {% else %}
        <!-- No Course Selected -->
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i>
          <strong>Select a course</strong> from the dropdown above to view student exam results.
          <br>
          <small>Results will be grouped by exam, showing MCQ scores and essay submissions for each student.</small>
        </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
  .border-left {
    border-left: 4px solid !important;
  }
  
  @media print {
    .card-header {
      background-color: #f8f9fa !important;
    }
    .accordion-button {
      display: none;
    }
    .accordion-body {
      display: block !important;
    }
  }
</style>
{% endblock %}
