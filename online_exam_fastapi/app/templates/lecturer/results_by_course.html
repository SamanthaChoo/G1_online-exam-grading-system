{% extends 'base.html' %}

{% block title %}Filter Results by Course{% endblock %}

{% block content %}

<style>
  .results-header-card {
    border-radius: 1rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 0.5rem 1rem rgba(102, 126, 234, 0.3);
  }
  .course-select-card {
    border-radius: 1rem;
    border: none;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.08);
  }
  .exam-group-card {
    border-radius: 0.75rem;
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: all 0.2s;
    margin-bottom: 1rem;
    overflow: hidden;
  }
  .exam-group-card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    transform: translateY(-3px);
  }
  .exam-status-bar {
    height: 4px;
    width: 100%;
  }
  .student-result-card {
    border-radius: 0.75rem;
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    transition: all 0.2s;
    margin-bottom: 1rem;
  }
  .student-result-card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
    transform: translateX(5px);
  }
  .score-badge {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    font-weight: 700;
    font-size: 1rem;
    box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
  }
  .mini-progress {
    height: 8px;
    border-radius: 1rem;
    background: #e9ecef;
    overflow: hidden;
  }
  .mini-progress-bar {
    height: 100%;
    border-radius: 1rem;
    transition: width 0.3s;
  }
</style>

<div class="container py-4">
  <!-- Header Card -->
  <div class="card border-0 results-header-card mb-4">
    <div class="card-body p-4">
      <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
        <div>
          <h2 class="h3 mb-2">
            <i class="bi bi-funnel-fill me-2"></i>View Results by Course
          </h2>
          <p class="mb-0 opacity-90">
            <i class="bi bi-list-check me-2"></i>Filter and view student exam results
          </p>
        </div>
        <div>
          <a href="/exams/results/lecturer" class="btn btn-light">
            <i class="bi bi-arrow-left me-2"></i>All Courses
          </a>
        </div>
      </div>
    </div>
  </div>
      
  <!-- Course Selection Card -->
  <div class="card course-select-card mb-4">
    <div class="card-header bg-white border-bottom" style="border-radius: 1rem 1rem 0 0;">
      <h5 class="mb-0">
        <i class="bi bi-book me-2"></i>Select a Course
      </h5>
    </div>
    <div class="card-body p-4">
      <form method="get" class="row g-3 align-items-end" id="courseForm">
        <div class="col-md-8">
          <label for="courseSelect" class="form-label fw-bold">Course</label>
          <select 
            id="courseSelect" 
            name="course_id" 
            class="form-select form-select-lg"
            onchange="handleCourseChange()"
          >
            <option value="">-- Select a Course --</option>
            {% for course in courses %}
              <option value="{{ course.id }}" {% if selected_course and selected_course.id == course.id %}selected{% endif %}>
                {{ course.code }} - {{ course.name }}
              </option>
            {% endfor %}
          </select>
          {% if not courses %}
            <small class="text-muted mt-2 d-block">No courses assigned to you.</small>
          {% endif %}
        </div>
        <div class="col-md-4">
          <button type="button" class="btn btn-outline-secondary w-100" onclick="window.location.href='/lecturer/results'">
            <i class="bi bi-x-circle me-2"></i>Clear Selection
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function handleCourseChange() {
      const form = document.getElementById('courseForm');
      const courseSelect = document.getElementById('courseSelect');
      
      if (courseSelect.value === '') {
        window.location.href = '/lecturer/results';
      } else {
        form.submit();
      }
    }
  </script>

  <!-- Results Section -->
  {% if selected_course %}
    {% if grouped_results %}
      <!-- Results Found -->
      <div class="alert alert-info border-0 shadow-sm" style="border-radius: 0.75rem;">
        <i class="bi bi-info-circle me-2"></i>
        Showing results for <strong>{{ selected_course.code }} - {{ selected_course.name }}</strong>
      </div>

      <!-- Results by Exam -->
      {% for exam_group in grouped_results %}
      <div class="exam-group-card">
        <div class="exam-status-bar bg-primary"></div>
        
        <div class="card-body p-4">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h4 class="mb-2">
                <i class="bi bi-file-text-fill me-2 text-primary"></i>{{ exam_group.exam.title }}
              </h4>
              <div class="d-flex flex-wrap gap-2">
                <span class="badge bg-secondary-subtle text-secondary">
                  <i class="bi bi-card-text me-1"></i>{{ exam_group.exam.subject }}
                </span>
                <span class="badge bg-warning-subtle text-warning">
                  <i class="bi bi-clock me-1"></i>{{ exam_group.exam.duration_minutes }} min
                </span>
                {% if exam_group.exam.status == 'scheduled' %}
                  <span class="badge bg-secondary">Scheduled</span>
                {% elif exam_group.exam.status == 'completed' %}
                  <span class="badge bg-success">Completed</span>
                {% else %}
                  <span class="badge bg-light text-dark">{{ exam_group.exam.status }}</span>
                {% endif %}
              </div>
            </div>
            <div class="text-end">
              <div class="badge bg-info" style="font-size: 1rem; padding: 0.5rem 1rem;">
                <i class="bi bi-people-fill me-1"></i>{{ exam_group.students|length }} Students
              </div>
            </div>
          </div>

          <!-- Student Results Cards -->
          <div class="mt-4">
            {% for result in exam_group.students %}
            <div class="student-result-card">
              <div class="card-body">
                <div class="row align-items-center g-3">
                  <!-- Student Info -->
                  <div class="col-md-3">
                    <div class="d-flex align-items-center gap-2">
                      <div style="width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; display: flex; align-items: center; justify-content: center; font-weight: 700;">
                        {{ result.student.name[0] }}
                      </div>
                      <div>
                        <strong class="d-block">{{ result.student.name }}</strong>
                        <small class="text-muted">
                          <i class="bi bi-person-badge me-1"></i>{{ result.student.matric_no }}
                        </small>
                      </div>
                    </div>
                  </div>

                  <!-- Submission Status -->
                  <div class="col-md-2">
                    {% if result.attempt.submitted_at %}
                      <span class="badge bg-success-subtle text-success" style="padding: 0.5rem 1rem;">
                        <i class="bi bi-check-circle me-1"></i>Submitted
                      </span>
                    {% elif result.attempt.status == 'timed_out' %}
                      <span class="badge bg-warning-subtle text-warning" style="padding: 0.5rem 1rem;">
                        <i class="bi bi-clock-history me-1"></i>Timed Out
                      </span>
                    {% else %}
                      <span class="badge bg-secondary-subtle text-secondary" style="padding: 0.5rem 1rem;">
                        {{ result.attempt.status }}
                      </span>
                    {% endif %}
                  </div>
                  
                  <!-- MCQ Score -->
                  <div class="col-md-2">
                    <div class="text-center">
                      <small class="text-muted d-block mb-1">MCQ Score</small>
                      {% if result.mcq_result %}
                        {% set mcq_percentage = (result.mcq_result.score / result.mcq_result.total_questions * 100) if result.mcq_result.total_questions > 0 else 0 %}
                        <div class="score-badge {% if mcq_percentage >= 70 %}bg-success-subtle text-success{% elif mcq_percentage >= 50 %}bg-warning-subtle text-warning{% else %}bg-danger-subtle text-danger{% endif %}">
                          <span>{{ result.mcq_result.score }}</span>
                          <small style="font-size: 0.7rem;">/{{ result.mcq_result.total_questions }}</small>
                        </div>
                        <small class="text-muted d-block mt-1">{{ "%.0f"|format(mcq_percentage) }}%</small>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </div>
                  </div>
                      
                  <!-- Essay Score -->
                  <div class="col-md-2">
                    <div class="text-center">
                      <small class="text-muted d-block mb-1">Essay Score</small>
                      {% if result.essay_total is not none %}
                        <div class="score-badge bg-info-subtle text-info">
                          <span>{{ result.essay_total }}</span>
                          <small style="font-size: 0.7rem;">pts</small>
                        </div>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </div>
                  </div>
                      
                  <!-- Total Score -->
                  <div class="col-md-3">
                    {% set mcq_score = result.mcq_result.score if result.mcq_result else 0 %}
                    {% set essay_score = result.essay_total if result.essay_total is not none else 0 %}
                    {% set total_score = mcq_score + essay_score %}
                    
                    <div class="text-center">
                      <small class="text-muted d-block mb-1">Total Score</small>
                      {% if result.mcq_result or result.essay_total is not none %}
                        <div class="score-badge bg-primary-subtle text-primary" style="width: 70px; height: 70px; font-size: 1.5rem;">
                          {{ total_score }}
                        </div>
                      {% else %}
                        <span class="text-muted">-</span>
                      {% endif %}
                    </div>
                  </div>
                </div>

                <!-- Essay Details Accordion (if there are essay answers) -->
                {% if result.essay_answers %}
                <div class="mt-3 pt-3 border-top">
                  <button 
                    class="btn btn-sm btn-outline-primary w-100" 
                    type="button" 
                    data-bs-toggle="collapse" 
                    data-bs-target="#essayContent{{ result.student.id }}_{{ exam_group.exam.id }}"
                  >
                    <i class="bi bi-chevron-down me-2"></i>View Essay Answers ({{ result.essay_answers|length }})
                  </button>
                  
                  <div id="essayContent{{ result.student.id }}_{{ exam_group.exam.id }}" class="collapse mt-3">
                    {% for answer in result.essay_answers %}
                    <div class="card mb-3 border-0" style="background: #f8f9fa;">
                      <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                          <h6 class="mb-0">
                            <span class="badge bg-primary me-2">Q{{ loop.index }}</span>
                            Question ID: {{ answer.question_id }}
                          </h6>
                          {% if answer.marks_awarded is not none %}
                            <span class="badge bg-success">Graded: {{ answer.marks_awarded }} pts</span>
                          {% else %}
                            <span class="badge bg-warning">Not Graded</span>
                          {% endif %}
                        </div>
                          
                        {% if answer.answer_text %}
                        <div class="mb-3">
                          <strong class="d-block mb-1"><i class="bi bi-chat-quote me-1"></i>Answer:</strong>
                          <div class="p-3 bg-white rounded border-start border-primary border-3">
                            {{ answer.answer_text }}
                          </div>
                        </div>
                        {% endif %}
                          
                        {% if answer.grader_feedback %}
                        <div>
                          <strong class="d-block mb-1"><i class="bi bi-chat-square-text me-1"></i>Feedback:</strong>
                          <p class="text-muted mb-0 ps-3">{{ answer.grader_feedback }}</p>
                        </div>
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% endfor %}

    {% else %}
      <!-- No Results Message -->
      <div class="card border-0 shadow-sm" style="border-radius: 1rem;">
        <div class="card-body text-center py-5">
          <div class="mb-4">
            <i class="bi bi-inbox" style="font-size: 5rem; color: #dee2e6;"></i>
          </div>
          <h4 class="text-muted mb-3">No Results Available</h4>
          <p class="text-muted mb-4">
            No results found for {{ selected_course.code }} - {{ selected_course.name }}.<br>
            This course may not have any exams yet, or exams may not have any student submissions.
          </p>
        </div>
      </div>
    {% endif %}

  {% else %}
    <!-- No Course Selected -->
    <div class="card border-0 shadow-sm" style="border-radius: 1rem;">
      <div class="card-body text-center py-5">
        <div class="mb-4">
          <i class="bi bi-filter-circle" style="font-size: 5rem; color: #dee2e6;"></i>
        </div>
        <h4 class="text-muted mb-3">Select a Course</h4>
        <p class="text-muted mb-4">
          Choose a course from the dropdown above to view student exam results.<br>
          Results will be grouped by exam, showing MCQ scores and essay submissions for each student.
        </p>
      </div>
    </div>
  {% endif %}
</div>

{% endblock %}
