<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <title>Exam Paper - {{ exam.title }}</title>
  <meta name="description" content="">
  <meta name="keywords" content="">

  <!-- Favicons -->
  <link href="/assets/img/favicon.png" rel="icon">
  <link href="/assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com" rel="preconnect">
  <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&family=Raleway:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900&display=swap" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">

  <!-- Main CSS File -->
  <link href="/assets/css/main.css" rel="stylesheet">

  <style>
    .timer-bar {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: #0d6efd;
      color: white;
      padding: 15px;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .timer-bar.warning {
      background: #ffc107;
      color: #000;
    }
    .timer-bar.danger {
      background: #dc3545;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    body {
      padding-top: 80px;
    }
    .question-card {
      margin-bottom: 25px;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 20px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .option-label {
      display: block;
      padding: 12px 15px;
      margin: 8px 0;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .option-label:hover {
      background: #f8f9fa;
      border-color: #0d6efd;
    }
    .option-label input[type="radio"]:checked + span {
      font-weight: bold;
    }
    .option-label input[type="radio"]:checked {
      accent-color: #0d6efd;
    }
    .autosave-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #28a745;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
      z-index: 1000;
    }
  </style>
</head>

<body>

  <!-- Timer Bar -->
  <div class="timer-bar" id="timerBar">
    <i class="bi bi-clock"></i> Time Remaining: <span id="timer">{{ exam.duration_minutes }}:00</span>
  </div>

  <!-- Auto-save Indicator -->
  <div class="autosave-indicator" id="autosaveIndicator">
    <i class="bi bi-check-circle"></i> Answers Saved
  </div>

  <main class="main">
    <section class="py-4">
      <div class="container">
        <!-- Exam Header -->
        <div class="text-center mb-4">
          <h2>{{ exam.title }}</h2>
          <p class="text-muted">Total Questions: {{ questions|length }}</p>
        </div>

        <!-- Exam Form -->
        <form id="examForm">
          <input type="hidden" name="student_id" value="{{ student_id }}">
          <input type="hidden" name="exam_id" value="{{ exam.id }}">

          <!-- Questions -->
          {% for question in questions %}
          <div class="question-card">
            <h5 class="mb-3">Question {{ loop.index }}</h5>
            <p class="mb-3">{{ question.question_text }}</p>

            <div class="options">
              <label class="option-label">
                <input type="radio" name="question_{{ question.id }}" value="A" 
                       {% if answer_map.get(question.id) == 'A' %}checked{% endif %}
                       data-question-id="{{ question.id }}">
                <span> <strong>A.</strong> {{ question.option_a }}</span>
              </label>

              <label class="option-label">
                <input type="radio" name="question_{{ question.id }}" value="B" 
                       {% if answer_map.get(question.id) == 'B' %}checked{% endif %}
                       data-question-id="{{ question.id }}">
                <span> <strong>B.</strong> {{ question.option_b }}</span>
              </label>

              <label class="option-label">
                <input type="radio" name="question_{{ question.id }}" value="C" 
                       {% if answer_map.get(question.id) == 'C' %}checked{% endif %}
                       data-question-id="{{ question.id }}">
                <span> <strong>C.</strong> {{ question.option_c }}</span>
              </label>

              <label class="option-label">
                <input type="radio" name="question_{{ question.id }}" value="D" 
                       {% if answer_map.get(question.id) == 'D' %}checked{% endif %}
                       data-question-id="{{ question.id }}">
                <span> <strong>D.</strong> {{ question.option_d }}</span>
              </label>
            </div>
          </div>
          {% endfor %}

          <!-- Submit Button -->
          <div class="text-center mb-4">
            <button type="button" class="btn btn-lg btn-primary" id="submitBtn">
              <i class="bi bi-check-circle"></i> Submit Exam
            </button>
          </div>
        </form>
      </div>
    </section>
  </main>

  <!-- Vendor JS Files -->
  <script src="/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Exam Timer & Auto-save Script -->
  <script>
    const examId = {{ exam.id | tojson }};
    const studentId = {{ student_id | tojson }};
    let remainingSeconds = {{ remaining_seconds | tojson }};
    
    // Timer Update Function
    function updateTimer() {
      if (remainingSeconds <= 0) {
        // Time's up - auto submit
        submitExam();
        return;
      }

      const minutes = Math.floor(remainingSeconds / 60);
      const seconds = remainingSeconds % 60;
      
      const timerDisplay = String(minutes).padStart(2, '0') + ':' + String(seconds).padStart(2, '0');
      document.getElementById('timer').textContent = timerDisplay;

      // Change timer color based on remaining time
      const timerBar = document.getElementById('timerBar');
      if (remainingSeconds <= 60) {
        timerBar.className = 'timer-bar danger';
      } else if (remainingSeconds <= 300) {
        timerBar.className = 'timer-bar warning';
      }

      remainingSeconds--;
    }

    // Start timer
    setInterval(updateTimer, 1000);
    updateTimer();

    // Collect Answers Function
    function collectAnswers() {
      const answers = [];
      const radioButtons = document.querySelectorAll('input[type="radio"]:checked');
      
      radioButtons.forEach(radio => {
        answers.push({
          question_id: parseInt(radio.dataset.questionId),
          selected_option: radio.value
        });
      });

      return answers;
    }

    // Auto-save Function (every 60 seconds)
    function autoSave() {
      const answers = collectAnswers();
      
      if (answers.length === 0) {
        return; // No answers to save yet
      }

      const data = {
        student_id: studentId,
        answers: answers
      };

      fetch(`/exam/paper/${examId}/autosave`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Show autosave indicator
          const indicator = document.getElementById('autosaveIndicator');
          indicator.style.display = 'block';
          setTimeout(() => {
            indicator.style.display = 'none';
          }, 2000);
        }
      })
      .catch(error => {
        console.error('Auto-save error:', error);
      });
    }

    // Auto-save every 60 seconds
    setInterval(autoSave, 60000);

    // Submit Exam Function
    function submitExam() {
      const answers = collectAnswers();
      
      const data = {
        student_id: studentId,
        answers: answers
      };

      // Disable submit button
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span> Submitting...';

      fetch(`/exam/paper/${examId}/submit`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          // Redirect to submitted page
          window.location.href = `/exam/submitted/${examId}?student_id=${studentId}`;
        } else {
          alert('Error submitting exam: ' + data.message);
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Exam';
        }
      })
      .catch(error => {
        console.error('Submit error:', error);
        alert('Error submitting exam. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Exam';
      });
    }

    // Submit button click handler
    document.getElementById('submitBtn').addEventListener('click', function(e) {
      e.preventDefault();
      
      if (confirm('Are you sure you want to submit your exam? This action cannot be undone.')) {
        submitExam();
      }
    });

    // Prevent accidental page close
    window.addEventListener('beforeunload', function(e) {
      e.preventDefault();
      e.returnValue = '';
      return '';
    });
  </script>

</body>

</html>
